name: Debug Build Issues

on:
  workflow_dispatch:
    inputs:
      ss_go_version:
        description: 'Shadowsocks-go version (e.g., v1.14.0)'
        required: true
        type: string
        default: 'v1.14.0'

jobs:
  test-download:
    name: Test Package Downloads
    runs-on: ubuntu-latest
    steps:
      - name: Test Download URLs
        run: |
          VERSION="${{ inputs.ss_go_version }}"
          echo "Testing version: $VERSION"
          echo ""
          
          # 测试各个架构
          for ARCH in "x86-64-v2" "x86-64-v3" "arm64"; do
            URL="https://github.com/database64128/shadowsocks-go/releases/download/${VERSION}/shadowsocks-go-${VERSION}-linux-${ARCH}.tar.zst"
            echo "Testing $ARCH:"
            echo "URL: $URL"
            
            # 检查URL是否存在
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$URL")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "✓ Available (HTTP $HTTP_STATUS)"
              # 尝试下载一小部分
              if curl -s -r 0-100 "$URL" | head -c 10 > /dev/null 2>&1; then
                echo "✓ Download test successful"
              else
                echo "✗ Download failed"
              fi
            else
              echo "✗ Not available (HTTP $HTTP_STATUS)"
            fi
            echo ""
          done

  simple-build:
    name: Simple Build Test
    runs-on: ubuntu-latest
    needs: test-download
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Minimal Dockerfile
        run: |
          cat > Dockerfile.test << 'EOF'
          FROM alpine:latest
          
          ARG SS_GO_VERSION
          
          RUN echo "Building with version: ${SS_GO_VERSION}"
          
          # 测试下载
          RUN echo "Testing download for arm64..." && \
              URL="https://github.com/database64128/shadowsocks-go/releases/download/${SS_GO_VERSION}/shadowsocks-go-${SS_GO_VERSION}-linux-arm64.tar.zst" && \
              echo "URL: $URL" && \
              wget --no-verbose "$URL" && \
              echo "Download successful!" && \
              ls -la
              
          RUN echo "Build complete!"
          EOF
          
          echo "Dockerfile created:"
          cat Dockerfile.test

      - name: Build Test
        run: |
          VERSION="${{ inputs.ss_go_version }}"
          echo "Building with Dockerfile.test..."
          docker build -f Dockerfile.test \
            --build-arg "SS_GO_VERSION=$VERSION" \
            -t test-build .
